name: ğŸ“Š Community Metrics Tracking

on:
  schedule:
    # Run weekly on Sunday at 12:00 UTC (Ğ¼ĞµĞ´Ğ¸Ñ‚Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·)
    - cron: '0 12 * * 0'
  workflow_dispatch:
    inputs:
      generate_report:
        description: 'Generate detailed community report'
        required: false
        default: 'true'
        type: boolean

jobs:
  collect-github-metrics:
    name: ğŸ“ˆ GitHub Community Metrics
    runs-on: ubuntu-latest
    if: github.repository_owner == 'playra'

    steps:
      - name: ğŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive analysis

      - name: ğŸ“Š Collect Repository Metrics
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            // ğŸ“Š Basic Repository Stats
            const repo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // ğŸ‘¥ Contributors Analysis
            const contributors = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // ğŸŒŸ Stars over time (last 30 days)
            const starredAt = await github.rest.activity.listStargazersForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              headers: {
                'Accept': 'application/vnd.github.v3.star+json'
              },
              per_page: 100
            });

            // ğŸ› Issues Analysis
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            // ğŸ”€ Pull Requests Analysis  
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            // ğŸ“¦ Releases Analysis
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50
            });

            const metrics = {
              repository: {
                name: repo.data.full_name,
                stars: repo.data.stargazers_count,
                forks: repo.data.forks_count,
                watchers: repo.data.subscribers_count,
                size: repo.data.size,
                language: repo.data.language,
                created_at: repo.data.created_at,
                updated_at: repo.data.updated_at
              },
              community: {
                contributors_count: contributors.data.length,
                top_contributors: contributors.data.slice(0, 5).map(c => ({
                  login: c.login,
                  contributions: c.contributions
                }))
              },
              engagement: {
                issues: {
                  total: issues.data.length,
                  open: issues.data.filter(i => i.state === 'open' && !i.pull_request).length,
                  closed: issues.data.filter(i => i.state === 'closed' && !i.pull_request).length
                },
                pull_requests: {
                  total: prs.data.length,
                  open: prs.data.filter(pr => pr.state === 'open').length,
                  merged: prs.data.filter(pr => pr.merged_at).length,
                  closed: prs.data.filter(pr => pr.state === 'closed' && !pr.merged_at).length
                },
                releases: {
                  total: releases.data.length,
                  latest: releases.data[0]?.tag_name || 'No releases'
                }
              },
              activity: {
                recent_stars: starredAt.data.slice(-30).length,
                stars_this_week: starredAt.data.filter(star => 
                  new Date(star.starred_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                ).length
              }
            };

            // Save metrics to file
            fs.writeFileSync('community-metrics.json', JSON.stringify(metrics, null, 2));

            // Generate summary for GitHub Step Summary
            const summary = `## ğŸ•‰ï¸ Sacred Community Metrics Report

            ### ğŸ“Š Repository Health
            - **â­ Stars**: ${metrics.repository.stars}
            - **ğŸ´ Forks**: ${metrics.repository.forks}
            - **ğŸ‘€ Watchers**: ${metrics.repository.watchers}
            - **ğŸ‘¥ Contributors**: ${metrics.community.contributors_count}

            ### ğŸ“ˆ Engagement Insights
            - **ğŸ› Issues**: ${metrics.engagement.issues.open} open / ${metrics.engagement.issues.total} total
            - **ğŸ”€ Pull Requests**: ${metrics.engagement.pull_requests.open} open / ${metrics.engagement.pull_requests.total} total
            - **ğŸ“¦ Releases**: ${metrics.engagement.releases.total} total (Latest: ${metrics.engagement.releases.latest})

            ### âš¡ Recent Activity
            - **ğŸŒŸ Stars This Week**: ${metrics.activity.stars_this_week}
            - **ğŸŒŸ Stars Last 30 Days**: ${metrics.activity.recent_stars}

            ### ğŸ† Top Contributors
            ${metrics.community.top_contributors.map(c => `- **${c.login}**: ${c.contributions} contributions`).join('\n')}

            ---

            *"à¤¸à¤°à¥à¤µà¥‡ à¤­à¤µà¤¨à¥à¤¤à¥ à¤¸à¥à¤–à¤¿à¤¨à¤ƒ à¤¸à¤°à¥à¤µà¥‡ à¤¸à¤¨à¥à¤¤à¥ à¤¨à¤¿à¤°à¤¾à¤®à¤¯à¤¾à¤ƒ"* - *"Ğ”Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²ÑĞµ ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹, Ğ´Ğ° Ğ±ÑƒĞ´ÑƒÑ‚ Ğ²ÑĞµ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²Ñ‹"*`;

            fs.writeFileSync('$GITHUB_STEP_SUMMARY', summary);

      - name: ğŸ“Š Generate Metrics Badge Data
        run: |
          # Generate shields.io compatible metrics
          STARS=$(cat community-metrics.json | jq '.repository.stars')
          FORKS=$(cat community-metrics.json | jq '.repository.forks')
          CONTRIBUTORS=$(cat community-metrics.json | jq '.community.contributors_count')

          echo "STARS_COUNT=$STARS" >> $GITHUB_ENV
          echo "FORKS_COUNT=$FORKS" >> $GITHUB_ENV
          echo "CONTRIBUTORS_COUNT=$CONTRIBUTORS" >> $GITHUB_ENV

      - name: ğŸ’¾ Store Historical Metrics
        run: |
          # Create metrics history directory if it doesn't exist
          mkdir -p .github/metrics-history

          # Store timestamped metrics
          TIMESTAMP=$(date +"%Y-%m-%d")
          cp community-metrics.json .github/metrics-history/metrics-$TIMESTAMP.json

          # Keep only last 12 weeks of data (3 months)
          find .github/metrics-history -name "metrics-*.json" -mtime +84 -delete || true

      - name: ğŸ“ˆ Generate Trend Analysis
        run: |
          echo "## ğŸ“ˆ Meditative Trend Analysis" >> trend-report.md
          echo "" >> trend-report.md

          # Compare with previous week's metrics if available
          LAST_WEEK=$(date -d '7 days ago' +"%Y-%m-%d" 2>/dev/null || date -v-7d +"%Y-%m-%d" 2>/dev/null || echo "")

          if [ -f ".github/metrics-history/metrics-$LAST_WEEK.json" ]; then
            CURRENT_STARS=$(cat community-metrics.json | jq '.repository.stars')
            PREVIOUS_STARS=$(cat .github/metrics-history/metrics-$LAST_WEEK.json | jq '.repository.stars' 2>/dev/null || echo "0")
            STARS_DIFF=$((CURRENT_STARS - PREVIOUS_STARS))
            
            echo "### ğŸŒŸ Weekly Growth" >> trend-report.md
            echo "- **Stars Change**: $STARS_DIFF (from $PREVIOUS_STARS to $CURRENT_STARS)" >> trend-report.md
            echo "" >> trend-report.md
          fi

          echo "*\"à¤šà¥ˆà¤¤à¤¨à¥à¤¯à¤‚ à¤¶à¤¾à¤¶à¥à¤µà¤¤à¤‚ à¤¶à¤¾à¤¨à¥à¤¤à¤‚\"* - *\"Ğ¡Ğ¾Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ²ĞµÑ‡Ğ½Ğ¾ Ğ¸ ÑƒĞ¼Ğ¸Ñ€Ğ¾Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾\"* ğŸ§˜â€â™‚ï¸" >> trend-report.md

      - name: ğŸ”„ Commit Metrics Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/metrics-history/
          git commit -m "ğŸ“Š chore: update community metrics history" || exit 0
          git push || exit 0

  notify-community-health:
    name: ğŸŒ± Community Health Check
    runs-on: ubuntu-latest
    needs: collect-github-metrics
    if: always() && github.repository_owner == 'playra'

    steps:
      - name: ğŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4

      - name: ğŸŒ± Check Community Health Score
        uses: actions/github-script@v6
        with:
          script: |
            const healthCheck = await github.rest.repos.getCommunityProfileMetrics({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const health = healthCheck.data;
            const score = health.health_percentage;

            const healthReport = `## ğŸŒ± Community Health Meditation

            ### ğŸ¥ Sacred Health Score: ${score}%

            #### âœ… Present Elements:
            ${health.files.readme ? '- ğŸ“– README.md' : ''}
            ${health.files.contributing ? '- ğŸ¤ CONTRIBUTING.md' : ''}
            ${health.files.code_of_conduct ? '- ğŸ“œ CODE_OF_CONDUCT.md' : ''}
            ${health.files.license ? '- âš–ï¸ LICENSE' : ''}
            ${health.files.issue_template ? '- ğŸ› Issue Templates' : ''}
            ${health.files.pull_request_template ? '- ğŸ”€ PR Template' : ''}

            #### ğŸ” Missing Elements:
            ${!health.files.readme ? '- âŒ README.md' : ''}
            ${!health.files.contributing ? '- âŒ CONTRIBUTING.md' : ''}
            ${!health.files.code_of_conduct ? '- âŒ CODE_OF_CONDUCT.md' : ''}
            ${!health.files.license ? '- âŒ LICENSE' : ''}
            ${!health.files.issue_template ? '- âŒ Issue Templates' : ''}
            ${!health.files.pull_request_template ? '- âŒ PR Template' : ''}

            ---

            *"à¤§à¤°à¥à¤®à¥‹ à¤°à¤•à¥à¤·à¤¤à¤¿ à¤°à¤•à¥à¤·à¤¿à¤¤à¤ƒ"* - *"Ğ”Ñ…Ğ°Ñ€Ğ¼Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµÑ…, ĞºÑ‚Ğ¾ Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ğ°ĞµÑ‚ ĞµÑ‘"* ğŸ›¡ï¸`;

            // Create an issue if health score is below 80%
            if (score < 80) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸŒ± Community Health Score Below 80%',
                body: healthReport + '\n\n**Action Required**: Please address missing community health elements to improve project accessibility and contribution guidelines.',
                labels: ['community', 'documentation', 'enhancement']
              });
            }

            console.log(healthReport);
