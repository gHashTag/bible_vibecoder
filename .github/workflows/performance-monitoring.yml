name: ðŸƒâ€â™€ï¸ Performance Monitoring

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 6 AM UTC (Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ)
    - cron: '0 6 * * *'

jobs:
  lighthouse-audit:
    name: ðŸ” Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule' || github.repository_owner == 'playra'

    steps:
      - name: ðŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4

      - name: ðŸ§˜â€â™‚ï¸ Setup Meditative Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: ðŸ“¦ Install Sacred Dependencies
        run: |
          npm install -g @lhci/cli@0.12.x
          bun install

      - name: ðŸ—ï¸ Build for Enlightenment
        run: bun run build
        continue-on-error: true

      - name: ðŸ” Run Lighthouse CI
        run: lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  bundle-analysis:
    name: ðŸ“¦ Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4

      - name: ðŸ§˜â€â™‚ï¸ Setup Meditative Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Sacred Dependencies
        run: bun install

      - name: ðŸ“Š Analyze Bundle Size
        run: |
          echo "## ðŸ“¦ Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§˜â€â™‚ï¸ Meditative Bundle Insights" >> $GITHUB_STEP_SUMMARY

          # Analyze TypeScript build output
          if [ -f "dist/index.js" ]; then
            size=$(du -h dist/index.js | cut -f1)
            echo "- **Main Bundle**: $size" >> $GITHUB_STEP_SUMMARY
          fi

          # Analyze node_modules size
          node_modules_size=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "N/A")
          echo "- **Dependencies Size**: $node_modules_size" >> $GITHUB_STEP_SUMMARY

          # Count dependencies
          deps_count=$(bun pm ls | wc -l || echo "N/A")
          echo "- **Dependencies Count**: $deps_count packages" >> $GITHUB_STEP_SUMMARY

  dependency-audit:
    name: ðŸ” Security & Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4

      - name: ðŸ§˜â€â™‚ï¸ Setup Meditative Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Sacred Dependencies
        run: bun install

      - name: ðŸ” Security Audit
        run: |
          echo "## ðŸ” Security Meditation Report" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ Sacred Protection Status" >> $GITHUB_STEP_SUMMARY

          # Run bun audit if available
          if bun audit --help >/dev/null 2>&1; then
            bun audit --json > audit-results.json || true
            if [ -f "audit-results.json" ]; then
              vulnerabilities=$(cat audit-results.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
              echo "- **Vulnerabilities Found**: $vulnerabilities" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Audit Status**: Bun audit not available, using npm audit" >> $GITHUB_STEP_SUMMARY
            npm audit --json > audit-results.json || true
            if [ -f "audit-results.json" ]; then
              vulnerabilities=$(cat audit-results.json | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
              echo "- **Vulnerabilities Found**: $vulnerabilities" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  performance-benchmarks:
    name: âš¡ Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ•‰ï¸ Sacred Checkout
        uses: actions/checkout@v4

      - name: ðŸ§˜â€â™‚ï¸ Setup Meditative Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ðŸ“¦ Install Sacred Dependencies
        run: bun install

      - name: âš¡ Run Performance Tests
        run: |
          echo "## âš¡ Performance Meditation Results" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸƒâ€â™€ï¸ Sacred Speed Insights" >> $GITHUB_STEP_SUMMARY

          # Test TypeScript compilation speed
          start_time=$(date +%s%N)
          bun run typecheck
          end_time=$(date +%s%N)
          compile_time=$(( (end_time - start_time) / 1000000 ))
          echo "- **TypeScript Compilation**: ${compile_time}ms" >> $GITHUB_STEP_SUMMARY

          # Test build speed
          start_time=$(date +%s%N)
          bun run build >/dev/null 2>&1 || true
          end_time=$(date +%s%N)
          build_time=$(( (end_time - start_time) / 1000000 ))
          echo "- **Build Time**: ${build_time}ms" >> $GITHUB_STEP_SUMMARY

          # Test test suite speed
          start_time=$(date +%s%N)
          bun test --silent >/dev/null 2>&1 || true
          end_time=$(date +%s%N)
          test_time=$(( (end_time - start_time) / 1000000 ))
          echo "- **Test Suite**: ${test_time}ms" >> $GITHUB_STEP_SUMMARY

  notify-performance:
    name: ðŸ“¢ Performance Notifications
    runs-on: ubuntu-latest
    needs:
      [
        lighthouse-audit,
        bundle-analysis,
        dependency-audit,
        performance-benchmarks,
      ]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“Š Generate Performance Report
        run: |
          echo "ðŸ•‰ï¸ **Daily Performance Meditation Complete**" >> performance-report.md
          echo "" >> performance-report.md
          echo "*\"à¤¤à¤¤à¥à¤¤à¥à¤µà¤®à¤¸à¤¿\"* - *\"Ð¢Ñ‹ ÐµÑÑ‚ÑŒ Ð¢Ð¾\"* - Ð£Ð¿Ð°Ð½Ð¸ÑˆÐ°Ð´Ñ‹" >> performance-report.md
          echo "" >> performance-report.md
          echo "### ðŸ“Š Sacred Metrics Summary" >> performance-report.md
          echo "- **Lighthouse Audit**: ${{ needs.lighthouse-audit.result }}" >> performance-report.md
          echo "- **Bundle Analysis**: ${{ needs.bundle-analysis.result }}" >> performance-report.md
          echo "- **Security Audit**: ${{ needs.dependency-audit.result }}" >> performance-report.md
          echo "- **Performance Benchmarks**: ${{ needs.performance-benchmarks.result }}" >> performance-report.md
          echo "" >> performance-report.md
          echo "*Ð”Ð° Ð¿Ñ€ÐµÐ±ÑƒÐ´ÐµÑ‚ Ñ Ð½Ð°Ð¼Ð¸ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ ÑÐ²ÐµÑ‚Ð° Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð‘Ñ€Ð°Ñ…Ð¼Ñ‹* ðŸ™" >> performance-report.md

      - name: ðŸ’¬ Comment on Latest Commit (if scheduled)
        if: github.event_name == 'schedule'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf8');

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: report
            });
